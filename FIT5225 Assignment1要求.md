# 1 概要与背景
该项目旨在构建一个名为CloudDetect的基于Web的系统。它将允许最终用户将图像发送到由Docker容器托管的Web服务，并接收到其上传图像中检测到的对象列表。该项目将利用YOLO（You Only Look Once）库，这是一种先进的实时目标检测系统，以及OpenCV（开源计算机视觉库）来执行所需的图像操作/转换。YOLO和OpenCV都是基于Python的开源计算机视觉和机器学习软件库。Web服务将作为容器托管在Kubernetes集群中。Kubernetes将用作容器编排系统。目标检测Web服务还设计为可以使用Python的Flask库的RESTful API。我们有兴趣通过改变发送到系统的请求数量（需求）和Kubernetes集群中现有Pod的数量（资源）来检查CloudDetect的性能，使用负载生成工具如Locust。

该任务具有以下目标：

- 编写一个Python **Web服务**，接受JSON对象格式的图像，使用YOLO和OpenCV处理图像，并返回一个包含检测到的对象列表的JSON对象。
- 为目标检测Web服务构建**Docker镜像**。
- 在Oracle Cloud Infrastructure（OCI）的虚拟机（实例）上创建**Kubernetes集群**。
- 部署一个**Kubernetes服务**，将入站请求分配到运行目标检测服务的Pod之间。
- 使用Loucust编写**负载生成**脚本。
- 在不同负载和Pod数量条件下**测试**系统。

您可以依次专注于这些目标，以获得部分分数。

# 2 Web服务
你需要开发一个RESTful API，允许客户端将图像上传到服务器。你必须使用**Flask**构建你的Web服务，并使用1024以上的任意端口。你的Flask服务器应该能够同时处理多个客户端。每个图像应该通过HTTP POST请求发送到Web服务，其中包含一个带有唯一ID（例如UUID）和base64编码图像的JSON对象。由于图像是二进制数据，它不能直接插入到JSON中。你必须将图像转换为可以用作普通字符串的文本表示形式。将图像编码为文本的最常见方法是使用base64方法。用于发送图像的示例JSON请求可能如下所示：
```
{
"id":"06e8b9e0-8d2e-11eb-8dcd-0242ac130003",
"image":"YWRzZmFzZGZhc2RmYXNkZmFzZGYzNDM1MyA7aztqMjUzJyBqaDJsM2 ..."
}
```
Web服务为每个请求创建一个线程，并使用YOLO和OpenCV Python库检测图像中的对象。作为建议，你可以从JSON消息的图像编码部分开始，考虑开发你的Web服务，并使用基本的Postman HTTP请求对其进行测试。确认你的Web服务功能正常后，你可以按照WebService API创建客户端请求，使用Locust进行测试。对于每个图像（请求），你的Web服务将返回一个JSON对象，其中包含该图像中检测到的所有对象的列表，如下所示：
```
{
"id":"The id from the client request",
"objects": [
{
"label": "human/book/cat/...",
"accuracy": a real number between 0-1,
"rectangle": {
"height": number,
"left": number,
"top": number,
"width": number
}
}
...
]
}
```
“id”与客户端一起发送的相同ID与图像。这用于将异步响应与客户端请求关联起来。“label”表示检测到的对象类型，例如，猫，书籍等。“Accuracy”表示对象检测的精度，而矩形是一个JSON对象，显示图像中物体周围的框的位置。示例响应如下所示：
```
{
"id": "2b7082f5-d31a-54b7-a46e-5e4889bf69bd",
"objects": [
{
"label": "book",
"accuracy": 0.7890481352806091,
"rectangle": {"height": 114, "left": 380, "top": 363, "width": 254}
},
{
"label": "cat",
"accuracy": 0.6877481352806091,
"rectangle": {"height": 114, "left": 180, "top": 63, "width": 254}
}
]
}
```
你需要使用yolov3-tiny框架开发一个快速可靠的对象检测RESTful API。你将使用预训练的网络权重，因此不需要自己训练对象检测程序。我们已经在yolo_tiny_configs.zip文件中提供了yolov3-tiny配置文件和权重。请注意，此网络是在COCO数据集上进行训练的（<http://cocodataset.org/#home>）。我们还为你提供了来自该数据集的一组样本图像（128张图像，位于zip文件中的inputfolder文件夹中），你应该使用它们进行测试。

# 3 Dockerfile
Docker通过从名为Dockerfile的文件中读取指令来构建镜像。Dockerfile是一个文本文件，包含构建给定镜像所需的所有有序命令。你需要创建一个Dockerfile，其中包含构建Docker镜像所需的所有指令。你可以在这里找到Dockerfile的参考文档：<https://docs.docker.com/engine/reference/builder/>。
为了降低复杂性、依赖关系、文件大小和构建时间，请避免安装额外或不必要的软件包，即使它们可能是“好用的”。例如，你不需要在镜像中包含文本编辑器。优化Dockerfile并保持易于阅读和维护的重要性。

# 4 Kubernetes集群
你的任务是在OCI VM上安装和配置一个Kubernetes集群。为此，你将在OCI上安装K8s在三个VM实例上（你的所有VM实例应该是*Intel机器*，形状为*VM.Standard.E4.Flex*，8GB内存和4个OCPUs）。你需要设置一个具有1个控制器和2个运行在OCI VM上的工作节点的K8s集群。你需要在VM上安装Docker引擎。你应该使用Kubeadm配置你的K8s集群。

# 5 Kubernetes服务
当你有一个运行的Kubernetes集群后，你需要创建服务和部署配置，这将依次在集群中创建并部署所需的Pod。Kubernetes的官方文档包含了许多关于如何从Docker镜像创建Pod、设置CPU和/或内存限制以及创建使用选择器的部署的步骤。请确保为每个Pod设置CPU请求和CPU限制为“0.5”，内存请求和限制为“512MiB”。
最初，你将从一个单独的Pod开始测试你的Web服务，并根据第7节的描述逐渐增加数量。实现这一目标的首选方法是创建副本集并相应地扩展它们。
最后，你需要暴露你的部署，以便与Pod中运行的Web服务进行通信。你可以利用**Service和NodePort**来暴露你的部署。你将需要从下一节描述的各种位置调用对象检测服务。OCI通过其网络安全措施限制对你的VM的访问。因此，你应该确保你的控制器实例打开了所有必要的端口，并且必要的网络配置，包括OCI的“安全列表”，已经正确设置。你可能还需要在实例级防火墙上打开端口（如防火墙或iptables）。

# 6 Locust负载生成
创建一个Locust脚本来模拟并发用户访问你的RESTful API。确保API可以处理负载并迅速响应，而不会崩溃或出现显著延迟。你的下一个任务是在负载测试期间监视和记录相关的性能指标，如响应时间、每秒查询数（QPS）和错误率。
首先，安装Locust（如果尚未安装），并熟悉其文档以创建负载测试场景。配置Locust脚本以逐渐增加用户数量并维持负载，以识别潜在的瓶颈。你的脚本应该能够将提供的128个图像编码为base64，并将它们嵌入到符合第2节规定的JSON消息中，以实现无缝集成。注意：你可以重用在第2节中开发的客户端代码的部分。

# 7 实验和报告
你的下一个目标是在集群中的不同资源数量（Pods）下测试系统能够处理的最大负载。当系统运行正常时，你将对集群中的不同数量的Pods（可用资源）进行实验。
你需要进行两组实验：一组是Locust客户端在Kubernetes的主节点上本地运行，另一组是在Nectar中的VM实例上运行。Pods的数量必须分别扩展为1、2、4和8个。考虑到每个Pod分配的有限CPU和内存（CPU请求和限制：0.5，内存请求和限制：512MiB），增加Pods的数量可以增加资源的可访问性。
你的目标是确定系统在经历故障之前能够处理的最大并发用户数。为了实现这一目标，变化Locust客户端中的并发用户数，分析增加负载对部署服务的影响。你可以将生成率设置为合理的值，以逐渐增加用户数以进行不同Pod配置的实验。对于每次试验，持续发送128张图像到服务器，直到响应时间稳定且成功率保持在100%。服务的响应时间是从最终用户发出请求到收到响应的持续时间。这些数据由Locust自动收集。当出现第一个失败的请求时，记录最大的并发用户数，将其减少一，并记录这个数字。然后使用记录的并发用户数和生成率为1个用户/秒重新运行实验，以确保100%的成功率。
最后，以表格形式报告你的结果，包括平均响应时间，如下所示：
![[Pasted image 20240416170405.png]]
确保对每个实验运行多次以验证实验的正确性和在各种实验中平均响应时间值的一致性。这是因为网络流量和其他环境因素可能会影响你的实验。
在你的报告中，讨论这个表格并解释你的观察结果。为了自动化你的实验并收集数据点，你可以编写一个脚本，自动变化实验的参数并收集数据点。
你的报告必须是最多1500个字，不包括表格和参考资料。你需要在报告中包括以下内容：
- 如上所述的表格。
- 解释你实验的结果和观察（1000字）。
- 从第一周研讨会上讨论的分布式系统挑战列表中选择三个挑战，给出你项目中的一个实际例子，说明该挑战以及在你的系统中如何解决（500字）。
使用12pt Times字体，单列，四周各1英寸的页边距。在报告顶部写上你的全名、导师姓名和学生号。

# 8 视频录制
你的视频提交应包括以下内容，演示你的任务：
• Web服务 -（约2分钟）打开你的应用程序源代码，简要解释你的程序方法论和总体架构。重点介绍如何创建Web服务，如何创建JSON消息。
• Dockerfile -（约1分钟）简要解释你容器化应用程序的方法。展示你的Dockerfile，并简要解释它。
• Kubernetes集群和Kubernetes服务 -（约4分钟）
1. 简要讨论你如何安装Docker和Kubernetes，并提及所使用的这些工具的版本。还要提一下你的设置中使用的Kubernetes的哪个网络模块以及为什么选择了它。
2. 列出你的集群节点（kubectl get nodes，使用-o wide），并解释cluster-info。
3. 展示你的部署YAML文件，并简要解释它。
4. 展示你的服务配置文件，并简要解释它。
5. 解释并展示你的Docker镜像是如何构建和加载到你的Kubernetes集群中的。
6. 展示OCI仪表板中的你的虚拟机。
7. 展示控制节点的公共IP地址及其安全组。如果你有VCN和子网，也可以讨论它们。解释为什么要配置安全组和端口。
8. 对于4个Pod的配置，通过列出你的Pods来展示你的部署是否正常工作。然后展示你的服务是否正常工作，并且可以通过在本地计算机上运行客户端代码从控制节点外部访问。
9. 最后，展示Pod的日志，以证明负载均衡正常工作。
• Locust脚本 -（约1分钟）解释你的Locust客户端，并展示一个快速演示。
• 实验 - 视频中不需要讨论此部分。
	**注意**：请注意，如果您的视频中没有涵盖上述要求的项目，即使您的代码和配置正常工作，您也会失去分数。
	**注意**：您的视频长度不得超过8分钟。请注意，任何超过此持续时间的内容都将受到惩罚。此外，请您不要将录制速度调整为1.5倍或2倍。如果审查人员无法以正常速度跟随您的讲话或理解您演示的内容，他们可能会对您进行处罚。
	**建议**：为了确保您在视频录制中不会错过任何重要的点，并且能够控制时间，我们建议您事先准备好一个脚本。在录制会话期间，随时可以参考您的脚本，并根据需要阅读。您还应该准备好所有需要复制粘贴的命令。

# 9 技术方面
• 在评分期间保持您的设置运行正常，因为我们可能会访问和测试您的服务。在教学团队宣布之前，请勿删除任何内容。确保在 ReadMe.txt 中提供您服务端点的 URL。
• 您可以使用任何编程语言。请注意，本项目描述的大部分内容是基于 Python 编写的。
• 确保在需要的地方安装所有必需的软件包。例如，python、Yolov3-tiny、opencv-python、flask、NumPy 等。
• 在运行实验时，不要将带宽用于其他网络活动，因为这可能会影响您的结果。
• 由于在云环境中失败是可能的，请确保定期备份您的工作和 VM 的快照。
• 确保您的 Kubernetes 服务正确地在 pod 之间分配任务（检查日志）。
• 确保为每个 pod 限制 CPU 和内存（0.5 和 512MiB）。
• 很重要的是，在每次实验后确保您的集群正常运行，必要时可能需要重新部署。

# 10 提交
您需要通过 Moodle 提交四个文件：

1. 根据要求的 PDF 格式报告。
2. 一个 ZIP 文件（不是 .RAR 或其他格式），其中包含以下内容：
   1. 您的 Dockerfile。
   2. 您的 Web 服务源代码。
   3. 您的 Kubernetes 部署和服务配置（YAML 文件）。
   4. 您的 Locust 客户端脚本。
   5. 如果有的话，任何自动运行实验的脚本。
3. 一个 ReadMe.txt 文件，其中包含：
   1. 演示您系统的 8 分钟视频的 URL。您可以使用 Google Drive、Panopto 或 YouTube，例如 https://www.youtube.com/watch?v=8frmloR4gTY&t=7s。
   2. 您 Web 服务端点的 URL，例如 http://118.138.43.2:5000/api/object detection。

请确保教学团队（所有导师和讲师）可以访问视频。如果您想要告知我们其他事项，可以在此 ReadMe 文件中使用。